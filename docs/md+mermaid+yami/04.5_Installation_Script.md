# EcoShower - Automated Installation Script

This script automates the entire installation process described in the Installation Guide.
It creates all AWS resources (DynamoDB, Cognito, Lambda, API Gateway, IoT, SNS, S3, and CloudFront), configures them, and deploys the application.

## 1. Prerequisites (דרישות מקדימות)

Before running the script, ensure you have:
1.  **AWS CLI** installed and configured (`aws configure` with Admin permissions).
2.  **Node.js 18+** and **npm** installed.
3.  **Python 3.11** installed.

## 2. The Script (הסקריפט)

Save the following code as `setup_project.sh` in the root of the project, run `chmod +x setup_project.sh`, and then executes it with `./setup_project.sh`.

```bash
#!/bin/bash
set -e # Exit immediately if a command exits with a non-zero status.

# ==========================================
# EcoShower - Automated Installation Script
# ==========================================

echo "============================================="
echo "   EcoShower Project - One-Click Installer   "
echo "============================================="

# 1. Configuration
export AWS_REGION=eu-north-1
export PROJECT_NAME=ecoshower
export ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
export BUCKET_NAME="ecoshower-frontend-$ACCOUNT_ID-$(date +%s)"

echo "Region: $AWS_REGION"
echo "Account ID: $ACCOUNT_ID"

# 2. DynamoDB Tables
echo "[1/9] Creating DynamoDB Tables..."

create_table() {
    local name=$1
    local key_schema=$2
    local attr_defs=$3
    
    echo "Creating table: $name..."
    aws dynamodb create-table \
        --table-name $name \
        --attribute-definitions $attr_defs \
        --key-schema $key_schema \
        --billing-mode PAY_PER_REQUEST \
        --region $AWS_REGION >/dev/null 2>&1 || echo "Table $name might already exist, skipping..."
}

create_table "EcoShower-Users" \
    "AttributeName=user_id,KeyType=HASH" \
    "AttributeName=user_id,AttributeType=S"

create_table "EcoShower-Devices" \
    "AttributeName=device_id,KeyType=HASH" \
    "AttributeName=device_id,AttributeType=S"

create_table "EcoShower-Sessions" \
    "AttributeName=session_id,KeyType=HASH" \
    "AttributeName=session_id,AttributeType=S"

aws dynamodb create-table \
    --table-name EcoShower-Telemetry \
    --attribute-definitions AttributeName=device_id,AttributeType=S AttributeName=timestamp,AttributeType=S \
    --key-schema AttributeName=device_id,KeyType=HASH AttributeName=timestamp,KeyType=RANGE \
    --billing-mode PAY_PER_REQUEST \
    --region $AWS_REGION >/dev/null 2>&1 || echo "Table EcoShower-Telemetry might already exist, skipping..."


# 3. Cognito
echo "[2/9] Configuring Cognito..."

USER_POOL_ID=$(aws cognito-idp create-user-pool \
    --pool-name EcoShower-Users \
    --auto-verified-attributes email \
    --username-attributes email \
    --region $AWS_REGION \
    --query 'UserPool.Id' --output text)

echo "Created User Pool: $USER_POOL_ID"

CLIENT_ID=$(aws cognito-idp create-user-pool-client \
    --user-pool-id $USER_POOL_ID \
    --client-name EcoShower-WebApp \
    --generate-secret false \
    --explicit-auth-flows ALLOW_USER_PASSWORD_AUTH ALLOW_REFRESH_TOKEN_AUTH ALLOW_USER_SRP_AUTH \
    --region $AWS_REGION \
    --query 'UserPoolClient.ClientId' --output text)

echo "Created Client ID: $CLIENT_ID"

aws cognito-idp create-group --user-pool-id $USER_POOL_ID --group-name admins --region $AWS_REGION >/dev/null 2>&1 || true
aws cognito-idp create-group --user-pool-id $USER_POOL_ID --group-name users --region $AWS_REGION >/dev/null 2>&1 || true

# Check if admin exists to avoid error
aws cognito-idp admin-get-user --user-pool-id $USER_POOL_ID --username admin@ecoshower.com --region $AWS_REGION >/dev/null 2>&1 || \
aws cognito-idp admin-create-user \
    --user-pool-id $USER_POOL_ID \
    --username admin@ecoshower.com \
    --user-attributes Name=email,Value=admin@ecoshower.com Name=name,Value="System Admin" Name=email_verified,Value=true Name=custom:role,Value=admin \
    --temporary-password "TempPass123!" \
    --region $AWS_REGION

aws cognito-idp admin-add-user-to-group --user-pool-id $USER_POOL_ID --username admin@ecoshower.com --group-name admins --region $AWS_REGION || true

# 4. IAM Roles
echo "[3/9] Creating IAM Roles..."

cat > lambda-trust-policy.json << EOF
{
    "Version": "2012-10-17",
    "Statement": [{"Effect": "Allow", "Principal": {"Service": "lambda.amazonaws.com"}, "Action": "sts:AssumeRole"}]
}
EOF

aws iam create-role --role-name EcoShower-LambdaRole --assume-role-policy-document file://lambda-trust-policy.json >/dev/null 2>&1 || true
# Attach policies with a small wait
sleep 5
aws iam attach-role-policy --role-name EcoShower-LambdaRole --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
aws iam attach-role-policy --role-name EcoShower-LambdaRole --policy-arn arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
aws iam attach-role-policy --role-name EcoShower-LambdaRole --policy-arn arn:aws:iam::aws:policy/AWSIoTDataAccess
aws iam attach-role-policy --role-name EcoShower-LambdaRole --policy-arn arn:aws:iam::aws:policy/AmazonSNSFullAccess
rm lambda-trust-policy.json

LAMBDA_ROLE_ARN=$(aws iam get-role --role-name EcoShower-LambdaRole --query 'Role.Arn' --output text)


# 5. Lambda Functions
echo "[4/9] Deploying Lambda Functions..."

cd src/lambda
# Zip files
zip -q api_handler.zip lambda_function.py
zip -q process_telemetry.zip process_telemetry.py

# Create ProcessTelemetry
aws lambda create-function \
    --function-name EcoShower-ProcessTelemetry \
    --runtime python3.11 \
    --role $LAMBDA_ROLE_ARN \
    --handler process_telemetry.lambda_handler \
    --zip-file fileb://process_telemetry.zip \
    --timeout 30 \
    --memory-size 256 \
    --environment "Variables={TELEMETRY_TABLE=EcoShower-Telemetry,DEVICES_TABLE=EcoShower-Devices,SESSIONS_TABLE=EcoShower-Sessions,USERS_TABLE=EcoShower-Users}" \
    --region $AWS_REGION >/dev/null 2>&1 || aws lambda update-function-code --function-name EcoShower-ProcessTelemetry --zip-file fileb://process_telemetry.zip --region $AWS_REGION >/dev/null

TELEMETRY_ARN=$(aws lambda get-function --function-name EcoShower-ProcessTelemetry --query 'Configuration.FunctionArn' --output text --region $AWS_REGION)

# Create API Handler
aws lambda create-function \
    --function-name EcoShower-API \
    --runtime python3.11 \
    --role $LAMBDA_ROLE_ARN \
    --handler lambda_function.lambda_handler \
    --zip-file fileb://api_handler.zip \
    --timeout 30 \
    --memory-size 256 \
    --environment "Variables={USERS_TABLE=EcoShower-Users,DEVICES_TABLE=EcoShower-Devices,SESSIONS_TABLE=EcoShower-Sessions,TELEMETRY_TABLE=EcoShower-Telemetry,USER_POOL_ID=$USER_POOL_ID}" \
    --region $AWS_REGION >/dev/null 2>&1 || aws lambda update-function-code --function-name EcoShower-API --zip-file fileb://api_handler.zip --region $AWS_REGION >/dev/null

rm api_handler.zip process_telemetry.zip
cd ../..

# 6. IoT Core
echo "[5/9] Configuring IoT Core..."
# Create rule to invoke ProcessTelemetry
aws lambda add-permission --function-name EcoShower-ProcessTelemetry --statement-id iot-rule-$(date +%s) --action lambda:InvokeFunction --principal iot.amazonaws.com --region $AWS_REGION >/dev/null 2>&1 || true

aws iot create-topic-rule \
    --rule-name EcoShower_ProcessTelemetry \
    --topic-rule-payload "{\"sql\": \"SELECT * FROM 'ecoshower/+/telemetry'\", \"actions\": [{\"lambda\": {\"functionArn\": \"$TELEMETRY_ARN\"}}], \"ruleDisabled\": false, \"awsIotSqlVersion\": \"2016-03-23\"}" \
    --region $AWS_REGION >/dev/null 2>&1 || true

# 7. API Gateway
echo "[6/9] Configuring API Gateway..."

API_ID=$(aws apigateway create-rest-api --name EcoShower-API --region $AWS_REGION --query 'id' --output text)
ROOT_ID=$(aws apigateway get-resources --rest-api-id $API_ID --query 'items[?path==`/`].id' --output text --region $AWS_REGION)

# Create Authorizer
AUTH_ID=$(aws apigateway create-authorizer --rest-api-id $API_ID --name CognitoAuth --type COGNITO_USER_POOLS --provider-arns "arn:aws:cognito-idp:$AWS_REGION:$ACCOUNT_ID:userpool/$USER_POOL_ID" --identity-source 'method.request.header.Authorization' --query 'id' --output text --region $AWS_REGION)

# Setup Proxy Integration to Lambda (Simplified to / and /{proxy+})
# For this script to be shorter, we use a global proxy to the API Lambda
# 1. Create ANY on /
aws apigateway put-method --rest-api-id $API_ID --resource-id $ROOT_ID --http-method ANY --authorization-type COGNITO_USER_POOLS --authorizer-id $AUTH_ID --region $AWS_REGION >/dev/null
aws apigateway put-integration --rest-api-id $API_ID --resource-id $ROOT_ID --http-method ANY --type AWS_PROXY --integration-http-method POST --uri "arn:aws:apigateway:$AWS_REGION:lambda:path/2015-03-31/functions/arn:aws:lambda:$AWS_REGION:$ACCOUNT_ID:function:EcoShower-API/invocations" --region $AWS_REGION >/dev/null

# 2. Create {proxy+} resource
PROXY_ID=$(aws apigateway create-resource --rest-api-id $API_ID --parent-id $ROOT_ID --path-part "{proxy+}" --query 'id' --output text --region $AWS_REGION)
aws apigateway put-method --rest-api-id $API_ID --resource-id $PROXY_ID --http-method ANY --authorization-type COGNITO_USER_POOLS --authorizer-id $AUTH_ID --region $AWS_REGION >/dev/null
aws apigateway put-integration --rest-api-id $API_ID --resource-id $PROXY_ID --http-method ANY --type AWS_PROXY --integration-http-method POST --uri "arn:aws:apigateway:$AWS_REGION:lambda:path/2015-03-31/functions/arn:aws:lambda:$AWS_REGION:$ACCOUNT_ID:function:EcoShower-API/invocations" --region $AWS_REGION >/dev/null

# Grant invoke permission to API Gateway
aws lambda add-permission --function-name EcoShower-API --statement-id apigateway-prod-$(date +%s) --action lambda:InvokeFunction --principal apigateway.amazonaws.com --source-arn "arn:aws:execute-api:$AWS_REGION:$ACCOUNT_ID:$API_ID/*/*/*" --region $AWS_REGION >/dev/null 2>&1 || true

# Deploy
aws apigateway create-deployment --rest-api-id $API_ID --stage-name prod --region $AWS_REGION >/dev/null
API_URL="https://$API_ID.execute-api.$AWS_REGION.amazonaws.com/prod"


# 8. S3 & CloudFront
echo "[8/9] Deploying Frontend to S3 & CloudFront..."

aws s3 mb s3://$BUCKET_NAME --region $AWS_REGION >/dev/null
# Configure config.js
cat > src/frontend/src/config.js << EOF
export const config = {
  API_URL: '$API_URL',
  COGNITO_USER_POOL_ID: '$USER_POOL_ID',
  COGNITO_CLIENT_ID: '$CLIENT_ID',
  AWS_REGION: '$AWS_REGION',
  WATER_COST_PER_LITER: 0.008,
  DEFAULT_TARGET_TEMP: 38,
  MIN_TEMP: 30,
  MAX_TEMP: 45,
  TELEMETRY_REFRESH_INTERVAL: 2000,
  DASHBOARD_REFRESH_INTERVAL: 30000,
};
export default config;
EOF

# Build & Sync
cd src/frontend
npm install && npm run build
aws s3 sync dist/ s3://$BUCKET_NAME --delete --region $AWS_REGION
cd ../..

# Create Distribution (Simplified OAI)
cat > cloudfront-config.json << EOF
{
    "CallerReference": "ecoshower-$(date +%s)",
    "Origins": {
        "Quantity": 1,
        "Items": [{
            "Id": "S3-$BUCKET_NAME",
            "DomainName": "$BUCKET_NAME.s3.amazonaws.com",
            "S3OriginConfig": {
                "OriginAccessIdentity": ""
            }
        }]
    },
    "DefaultCacheBehavior": {
        "TargetOriginId": "S3-$BUCKET_NAME",
        "ViewerProtocolPolicy": "redirect-to-https",
        "AllowedMethods": {
            "Quantity": 2,
            "Items": ["GET", "HEAD"]
        },
        "ForwardedValues": {
            "QueryString": false,
            "Cookies": {"Forward": "none"}
        },
        "MinTTL": 0,
        "DefaultTTL": 86400
    },
    "Enabled": true,
    "Comment": "EcoShower Frontend"
}
EOF

# Note: CloudFront creation takes time, printing ID potentially. 
# For speed in script, we can skip waiting for full deployment status.
CF_ID=$(aws cloudfront create-distribution --distribution-config file://cloudfront-config.json --query 'Distribution.DomainName' --output text || echo "Manual CF Setup Required")
rm cloudfront-config.json

# 9. SNS
echo "[9/9] Creating SNS Topic..."
aws sns create-topic --name EcoShower-Notifications --region $AWS_REGION >/dev/null


echo ""
echo "============================================="
echo "   INSTALLATION COMPLETE!                    "
echo "============================================="
echo "Frontend URL: https://$CF_ID"
echo "API URL: $API_URL"
echo "Admin Email: admin@ecoshower.com"
echo "Admin Password: TempPass123!"
echo "============================================="
```
